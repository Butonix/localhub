{# Copyright (c) 2020 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% load i18n %}
{% load rules %}
{% load hashtags %}
{% load activities %}
{% load users %}

{% has_perm "communities.moderate_community" user community as can_moderate_community %}

<article role="{{ object_type }}"
         id="{{ object_type }}-{{ object.id }}"
         class="card{% if css_class %} {{ css_class }}{% endif %}"
         data-controller="clipboard{% if is_content_sensitive %} toggle{% endif %}">
  {% block header %}
  {% if is_content_sensitive %}
  <div class="mb-2"
       data-target="toggle.togglable">
    <div class="">
      {% include "includes/timesince.html" with timestamp=object.published|default:object.created owner=object.owner %}
    </div>
  </div>
  <div class="hidden"
       data-target="toggle.togglable">
    {% else %}
    <div class="mb-4">
      {% endif %}

      <div class="font-semibold flex flex-wrap items-center mb-2">

        {% if object.is_reshare %}

        <div class="mr-4 tracking-tight">
          {% include "includes/timesince.html" with timestamp=object.published|default:object.created owner=object.owner verb="reshared" %}
        </div>

        {% if object.parent and not object.parent.deleted %}
        <a href="{{ object.parent.get_absolute_url }}">{{ object.title|truncatechars:130 }}</a>
        {% endif %}

        {% else %}

        {% block title %}

        <div class="tracking-tight flex items-center">

          {% if is_detail %}

          {% block detail_title %}
          {% if object.url %}
          {{ object.url|linkify:object.title }}
          {% else %}
          <span class="mr-4">
            {{ object.title|linkify_hashtags|linkify_mentions }}
          </span>
          {% endif %}
          {% endblock %}

          {% else %}

          {% with object.title|truncatechars:130 as object_title %}

          {% block list_item_title %}
          <a class="inline-block mr-4"
             href="{{ object.get_absolute_url }}">{{ object_title }}</a>
          {% endblock %}

          {% endwith %}

          {% endif %}

          <span class="tag inline-block mr-4">{{ object_type|title }}</span>

          {% if not object.published %}
          <span class="tag inline-block mr-4">{% trans "Private" %}</span>
          {% endif %}

          {% if can_moderate_community and object.is_flagged %}
          <span class="tag inline-block mr-4">{% trans "Flagged" %}</span>
          {% endif %}

          {% if object.is_new %}
          <span class="tag inline-block">{% trans "New" %}</span>
          {% endif %}

        </div>
        {% endblock title %}
        {% endif %}

      </div>

      <div class="flex flex-wrap items-center mb-2">
        {% if object.parent %}
        {% include "includes/timesince.html" with timestamp=object.parent.published|default:object.created owner=object.parent.owner %}
        {% elif not object.is_reshare %}
        {% include "includes/timesince.html" with timestamp=object.published|default:object.created owner=object.owner %}
        {% endif %}
      </div>

      {% if object.url or object.hashtags or object.mentions %}
      <div class="text-sm">
        {% if object.url %}
        <div class="mr-4">
          {{ object.url|domain|linkify }}
        </div>
        {% endif %}
        {% if object.hashtags %}
        <div class="mr-4">
          {{ object.hashtags|linkify_hashtags }}
        </div>
        {% endif %}
        {% if object.mentions %}
        <div class="">
          {{ object.mentions|linkify_mentions }}
        </div>
        {% endif %}
      </div>
      {% endif %}

    </div>
    {% endblock header %}

    {% block body %}
    <div class="">
      {% if object.is_reshare and not object.parent or object.parent.deleted %}
      {% trans "[Deleted]" %}
      {% else %}
      {% if object.is_reshare %}<blockquote>{% endif %}
        {% if is_content_sensitive %}
        <div class=""
             data-target="toggle.togglable">
          <p class="">{% trans "Sensitive Content" %}</p>
          <p class="">
            {% trans "This post has been tagged sensitive. You can view all sensitive content by default in your settings." %}
          </p>
          <p>
            {% for tag in object.get_content_warning_tags %}
            #{{ tag }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </p>
          <div class="">
            <button class=""
                    data-action="toggle#toggle">{% trans "Show Content" %}</button>
          </div>
        </div>
        <div class="hidden"
             data-target="toggle.togglable">
          {% endif %}
          {% with ignore_collapsable=is_detail|default:is_content_sensitive %}
          {% collapsable ignore_collapsable %}
          {% block content %}{% endblock %}
          {% endcollapsable %}
          {% endwith %}
          {% if is_content_sensitive %}</div>{% endif %}
        {% if object.is_reshare %}
      </blockquote>{% endif %}
      {% endif %}
    </div>
    {% endblock body %}

    {% block footer %}

    <div class="card-footer">
      <div class="flex-items-center">
        {% block info %}{% include "activities/includes/info.html" %}{% endblock %}
      </div>
      <div class="flex items-center">
        {% block actions %}{% include "activities/includes/actions.html" %}{% endblock %}
        {% block links %}{% include "activities/includes/links.html" %}{% endblock %}
      </div>
    </div>
    {% endblock footer %}
</article>
