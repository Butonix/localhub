{# Copyright (c) 2020 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% load i18n %}
{% load rules %}

<div class="dropdown mr-2"
     data-controller="dropdown"
     data-action="click@window->dropdown#close keydown@window->dropdown#close">
  <button class="btn btn-sm"
          data-action="dropdown#toggle">
    {% trans "Actions" %}<i class="icon icon-caret"></i>
  </button>
  <ul class="menu"
      data-target="dropdown.menu">

    {% has_perm "activities.pin_activity" user object as can_pin %}

    {% if can_pin %}
    {% if object.is_pinned %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"unpin" }}"
         class="text-strike"
         data-turbolinks="false"
         data-controller="ajax"
         data-action="ajax#post">{% trans "Pin" %}</a>
    </li>
    {% else %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"pin" }}"
         data-turbolinks="false"
         data-controller="ajax"
         data-action="ajax#post">{% trans "Pin" %}</a>
    </li>
    {% endif %}
    {% endif %}

    {% if not is_detail %}

    {% has_perm "activities.create_comment" user object as can_create_comment %}
    {% if can_create_comment %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"comment" }}">
        {% trans "Comment" %}
      </a>
    </li>
    {% endif %}
    {% endif %}

    {% has_perm "activities.like_activity" user object as can_like %}
    {% if can_like %}
    <li class="menu-item"
        data-controller="ajax">
      <a href="{{ object|resolve_url:"dislike" }}"
         data-turbolinks="false"
         class="text-strike{% if not object.has_liked %} d-none{% endif %}"
         data-target="ajax.toggle ajax.button"
         data-action="ajax#post">{% trans "Like" %}</a>
      <a href="{{ object|resolve_url:"like" }}"
         data-turbolinks="false"
         {% if object.has_liked %}
         class="d-none"
         {% endif %}
         data-target="ajax.toggle ajax.button"
         data-action="ajax#post">{% trans "Like" %}</a>
    </li>
    {% endif %}

    {% has_perm "activities.bookmark_activity" user object as can_bookmark %}
    {% if can_bookmark %}
    <li class="menu-item"
        data-controller="ajax">
      <a href="{{ object|resolve_url:"remove_bookmark" }}"
         data-turbolinks="false"
         class="text-strike{% if not object.has_bookmarked %} d-none{% endif %}"
         data-target="ajax.toggle ajax.button"
         data-action="ajax#post">{% trans "Bookmark" %}</a>
      <a href="{{ object|resolve_url:"bookmark" }}"
         data-turbolinks="false"
         {% if object.has_bookmarked %}
         class="d-none"
         {% endif %}
         data-target="ajax.toggle ajax.button"
         data-action="ajax#post">{% trans "Bookmark" %}</a>
    </li>
    {% endif %}


    {% if not object.has_reshared %}
    {% has_perm "activities.reshare_activity" user object as can_reshare %}
    {% if can_reshare %}
    <li class="menu-item">
      <a data-controller="ajax"
         data-turbolinks="false"
         data-action="ajax#post"
         href="{{ object|resolve_url:"reshare" }}">{% trans "Reshare" %}</a>
    </li>
    {% endif %}
    {% endif %}

    {% has_perm "activities.flag_activity" user object as can_flag %}
    {% if can_flag and not object.has_flagged %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"flag" }}">
        {% trans "Flag" %}
      </a>
    </li>
    {% endif %}

    {% has_perm "activities.change_activity" user object as can_change %}
    {% if can_change %}

    {% if not object.published %}
    <li class="menu-item">
      <a data-controller="ajax"
         data-turbolinks="false"
         data-action="ajax#post"
         data-ajax-confirm-header="{% trans 'Publish' %}"
         data-ajax-confirm-body="{% blocktrans trimmed %}Are you sure you want to publish this {{ object_type }}? You cannot reverse this action.{% endblocktrans %}"
         href="{{ object|resolve_url:"publish" }}">{% trans "Publish" %}</a>
      {% endif %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"update" }}">{% trans "Edit" %}</a>
    </li>
    {% endif %}


    {% has_perm "activities.change_activity_tags" user object as can_change_tags %}
    {% if can_change_tags %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"update_tags" }}">{% trans "Edit Tags" %}</a>
    </li>
    {% endif %}

    {% has_perm "activities.delete_activity" user object as can_delete %}
    {% if can_delete %}
    <li class="menu-item">
      <a href="{{ object|resolve_url:"delete" }}"
         data-turbolinks="false"
         data-controller="ajax"
         data-action="ajax#post"
         {% if not is_detail %}
         data-ajax-redirect="{{ request.get_full_path }}"
         {% endif %}
         data-ajax-confirm-header="{% trans 'Delete' %}"
         data-ajax-confirm-body="{% blocktrans %}Are you sure you want to delete this {{ object_type }}?{% endblocktrans %}">
        {% trans "Delete" %}</a>
    </li>
    {% endif %}

    {% if object.description %}
    <li class="menu-item">
      <a href="#"
         data-turbolinks="false"
         data-target="clipboard.button"
         data-action="clipboard#copy">
        {% trans "Copy Markdown" %}
      </a>
    </li>
    {% endif %}
    {% block extra_actions %}{% endblock %}
  </ul>
</div>
