{% extends "activities/base.html" %}

{% load i18n %}
{% load rules %}
{% load micawber_tags %}

{% block activities_content %}

{% has_perm "activities.change_activity" user event as can_change_event %}
{% has_perm "activities.delete_activity" user event as can_delete_event %}
{% has_perm "activities.like_activity" user event as can_like_event %}
{% has_perm "comments.create_comment" user event as can_create_comment %}

<div class="card content-card">
  <div class="card-header">
    <div class="card-subtitle text-gray float-right">
      {% blocktrans with event.created|timesince as created %}{{ created }} ago{% endblocktrans %}
    </div>
    <div class="card-title h3">{{ event.title }}</div>
    <div class="card-subtitle h6"><a href="{{ event.owner.get_profile_url }}">{{ event.owner.username }}</a></div>
    <!-- starts, ends -->
  </div>
  <div class="card-body">
    <div class="divider"></div>
    {% if event.description %}
    <div>
      {{ event.description.markdown }}
    </div>
    {% endif %}
    {% if event.url %}
    <div>
      {{ event.url|oembed }}
    </div>
    {% endif %}
  </div>
  <div class="card-footer">

    <div class="d-flex content-actions">

      {% if event.owner_id == user.id %}
      <div class="mr-2">{% trans "Likes" %} ({{ event.num_likes }})</div>
      {% elif can_like_event %}
      <div class="mr-2">
        <a href="#"
           data-controller="ajax"
           data-action="ajax#post"
           data-ajax-url=""
           data-ajax-replace="true"
           >{% trans "Like" %}</a>
      </div>
      {% endif %}

      <!--
        <div class="mr-2">
        <a href="">{% trans "Flag" %}</a>
        </div>
      -->

      {% if can_change_event %}
      <div class="mr-2">
        <a href="{% url 'events:update' event.id %}"
           >{% trans "Update" %}</a>
      </div>
      {% endif %}

      {% if can_delete_event %}
      <div class="mr-2">
        {% url 'events:delete' event.id as delete_url %}
        <a href="{{ delete_url }}"
           data-controller="ajax confirm"
           data-action="confirm#check ajax#delete"
           data-ajax-url="{{ delete_url }}"
           data-confirm-header="{% trans 'Delete Event' %}"
           data-confirm-body="{% trans 'Are you sure you want to delete this event?' %}"
           >{% trans "Delete" %}</a>
      </div>
      {% endif %}

      <div class="">
        <a href="{{ event.get_permalink }}">{% trans "Permalink" %}</a>
      </div>
    </div>
  </div>

</div>

<div class="divider"></div>

<div id="comments">
  {% if comments %}
  <h4>{% trans "Comments" %}</h4>
  {% endif %}
  {% for comment in comments %}
  <div class="mb-2">
    {% include "comments/includes/comment.html" %}
  </div>
  {% endfor %}
  {% if comment_form %}
  <div class="divider"></div>
  <h4>{% trans "Post a Comment" %}</h4>
  <form method="POST" action="{% url 'comments:create' event.id %}" data-controller="form" data-action="form#submit">
    {% include "includes/forms/fields.html" with form=comment_form %}
    <button class="btn btn-primary" type="submit">{% trans "Submit" %}</button>
  </form>
  {% elif not user.is_authenticated %}
  <p class="bg-gray p-2 text-center">
    {% url 'account_login' as login_url %}
    {% blocktrans %}Please <a href="{{ login_url }}">sign in</a> to post comments.{% endblocktrans %}
  </p>
  {% else %}
  <p class="bg-gray p-2 text-center">
    {% trans "You do not have permission to post comments on this site." %}
  </p>

  {% endif %}
</div>
{% endblock activities_content %}
