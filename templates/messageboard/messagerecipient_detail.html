{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% extends "messageboard/base.html" %}

{% load i18n %}
{% load account %}

{% block messageboard_header %}{% endblock %}

{% block messageboard_content %}
{% with message=object.message %}
{% user_display message.sender as sender %}
<ul class="breadcrumb">
    <li class="breadcrumb-item">
        <a href="{% url 'messageboard:message_recipient_list' %}">{% trans "Inbox" %}</a>
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'messageboard:sender_message_recipient_list' message.sender.username %}">{{ sender }}</a>
    </li>
    <li class="breadcrumb-item">
        <a href="#">{{ message.subject|truncatechars:60 }}</a>
    </li>
</ul>

<div class="btn-group float-right">
    <a href="{% url 'messageboard:message_create_reply' message.id %}" class="btn btn-sm">
        {% trans "Reply" %}
    </a>
    <a href="{% url 'messageboard:message_recipient_delete' object.id %}"
       class="btn btn-sm"
       data-controller="ajax confirm"
       data-action="confirm#check ajax#delete"
       data-confirm-header="{% trans 'Delete' %}"
       data-confirm-body="{% trans 'Are you sure you want to delete this message?' %}"
       >
       {% trans "Delete" %}
    </a>
</div>
<div class="clearfix"></div>

<dl>
    <dt>{% trans "Subject" %}</dt>
    <dd>{{ message.subject }}</dd>
    {% with parent=message.parent %}
    {% if parent.sender == user %}
    <dt>{% trans "Reply to" %}</dt>
    <dd><a href="{{ parent.get_absolute_url }}">{{ parent.subject }}</a></dd>
    {% endif %}
    {% endwith %}
    <dt>{% trans "From" %}</dt>
    <dd>
    {% include "users/includes/chip.html" with profile=message.sender %}
    <a href="{% url 'messageboard:sender_message_recipient_list' message.sender.username %}">{% trans "See all from this user" %}</a>
    </dd>
    <dt>{% trans "Received" %}</dt>
    <dd>{{ message.created|date:"DATETIME_FORMAT" }}</dd>
</dl>
<div class="divider"></div>
<div class="markdown-content">
    {{ message.message.markdown }}
</div>
{% if replies %}
<h6>{% trans "My Replies" %}</h6>
{% for reply in replies %}
<div class="card mb-1">
    <div class="card-header">
        <div class="card-title">

            <a href="{{ reply.get_absolute_url }}">{{ reply.subject }}
                {% blocktrans with since=reply.created|timesince %}
                {{ since }} ago
                {% endblocktrans %}
            </a>
        </div>
        <div class="card-subtitle text-gray">
            {% blocktrans with created=reply.created|timesince %}
            {{ created }}
            {% endblocktrans %}
        </div>
    </div>
    <div class="card-body">
        <p class="markdown-content">
            {{ reply.message.markdown|truncatechars_html:60 }}
        </p>
    </div>
</div>
{% endfor %}
{% endif %}

{% endwith %}
{% endblock messageboard_content %}

