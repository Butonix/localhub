{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% extends "conversations/base.html" %}

{% load i18n %}
{% load account %}
{% load rules %}
{% load users_tags %}

{% block content %}
<div data-controller="scroll">
    <h3>
        {% avatar object "avatar-lg" %}
        {% user_display object %}
    </h3>
    <div class="actions" data-controller="toggle">
        {% has_perm "users.block_user" user object as can_block_user %}
        {% has_perm "users.follow_user" user object as can_follow_user %}

        {% if message_form and object_list %}
        {% if page_obj.number == 1 %}
        <a href="#message-form" data-action="scroll#scroll" >{% trans "Send Message" %}</a>
        {% else %}
        <a href="{{ request.path }}?page=1#message-form">{% trans "Send Message" %}</a>
        {% endif %}
        {% endif %}

        {% if can_follow_user %}
        {% with following=user.following.all %}
        <a href="{% url 'users:unfollow' object.username %}"
           {% if object not in following %}class="d-hide"{% endif %}
           data-controller="ajax"
           data-action="ajax#post toggle#toggle"
           data-target="toggle.togglable"
           data-toggle-target="follow"
           data-ajax-redirect="none">
            {% trans "Unfollow" %}
        </a>
        <a href="{% url 'users:follow' object.username %}"
           {% if object in following %}class="d-hide"{% endif %}
           data-controller="ajax"
           data-action="ajax#post toggle#toggle"
           data-target="toggle.togglable"
           data-toggle-target="follow"
           data-ajax-redirect="none">
            {% trans "Follow" %}
        </a>
        {% endwith %}
        {% endif %}

        {% if can_block_user %}
        {% with blocked=user.blocked.all %}
        <a href="{% url 'users:unblock' object.username %}"
           {% if object not in blocked %}class="d-hide"{% endif %}
           data-controller="ajax"
           data-action="ajax#post toggle#toggle"
           data-target="toggle.togglable"
           data-toggle-target="block"
           data-ajax-redirect="none">
            {% trans "Unblock" %}
        </a>
        <a href="{% url 'users:block' object.username %}"
           {% if object in blocked %}class="d-hide"{% endif %}
           data-controller="ajax"
           data-action="ajax#post toggle#toggle"
           data-target="toggle.togglable"
           data-toggle-target="block"
           data-ajax-redirect="none">
            {% trans "Block" %}
        </a>
        {% endwith %}
        {% endif %}


        <a href="{{ object.get_absolute_url }}">{% trans "About" %}</a>
    </div>
    <div class="divider"></div>

    {% if paginator.count or view.search_query %}
    {% include "includes/search_form.html" %}
    {% endif %}

    {% include "conversations/includes/email_settings.html" %}

    {% if object_list %}
    {% include "includes/pagination.html" %}
    {% for message in object_list reversed %}
    <div class="card mb-1 {% if message.sender == user %} bg-gray{% endif %}">
        <div class="card-header">
            <div class="card-title h6">
                <span class="timesince">
                    {% blocktrans with created=message.created|timesince %}
                    Sent {{ created }} ago by
                    {% endblocktrans %}
                    {% include "users/includes/chip.html" with profile=message.sender %}
                </span>
            </div>
        </div>
        <div class="card-body">
            {% include "conversations/includes/message.html" %}
        </div>
        <div class="card-footer">
            <div class="actions">
                <a href="{{ message.get_permalink }}">{% trans "Permalink" %}</a>
                {% if message.sender == request.user %}

                <a href="{% url 'conversations:message_delete' message.id %}"
                   data-controller="ajax confirm"
                   data-action="confirm#check ajax#delete"
                   data-ajax-redirect="{{ request.path }}"
                   data-confirm-header="{% trans 'Delete' %}"
                   data-confirm-body="{% trans 'Are you sure you want to delete this message?' %}"
                   >{% trans "Delete" %}</a>

                {% elif not message.read %}
                <a href="{% url 'conversations:message_mark_read' message.id %}"
                   data-controller="ajax"
                   data-action="ajax#post"
                   data-ajax-redirect="{{ request.path }}"
                   >{% trans "Mark As Read" %}</a>

                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    {% include "includes/empty.html" %}
    {% endif %}

    {% if message_form and page_obj.number == 1 %}
    <div class="divider"></div>
    <form method="POST"
          id="message-form"
          data-target="scroll.scrollable"
          action="{% url 'conversations:message_create' object.username %}"
          data-controller="form"
          data-action="form#submit beforeunload@window->form#unload turbolinks:before-visit@window->form#unload">
          {% include "includes/forms/fields.html" with form=message_form %}
          <button type="submit" class="btn btn-primary">
              {% trans 'Submit' %}
          </button>
    </form>
    {% endif %}
    {% if page_obj.number != 1 %}
    {% include "includes/pagination.html" %}
    {% endif %}
</div>
{% endblock %}
