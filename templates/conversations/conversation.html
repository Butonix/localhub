{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% extends "conversations/base.html" %}

{% load i18n %}
{% load account %}
{% load rules %}
{% load conversations_tags %}
{% load users_tags %}

{% block conversations_subtitle %} | {% user_display user_obj %}{% endblock %}

{% block content %}
<h3>{% trans "Conversations" %}</h3>
<h4>
    {% avatar user_obj "avatar-lg" %}
    <a href="{{ user_obj.get_absolute_url }}">{% user_display user_obj %}</a>
</h4>
<div class="actions" data-controller="toggle">
      {% get_unread_message_count user community as unread_messages %}
      <span {% if unread_messages %}class="badge" data-badge="{{ unread_messages }}"{% endif %}>
        <a href="{% url 'conversations:inbox'%}">{% trans "Inbox" %}</a>
      </span>

    <a href="{% url 'conversations:outbox' %}">{% trans "Outbox" %}</a>
    {% has_perm "conversations.create_message" user community as can_create_message %}

    {% if can_create_message and user not in user_obj.blocked.all %}
    <a href="{% url 'conversations:message_create' user_obj.username %}">{% trans "Send Message" %}</a>
    {% endif %}

</div>
<div class="divider"></div>

{% if paginator.count or view.search_query %}
{% include "includes/search_form.html" %}
{% endif %}

{% include "conversations/includes/email_settings.html" %}

{% if object_list %}
{% for message in object_list %}
<div class="card mb-1 {% if message.sender == user %} bg-gray{% endif %}">
    <div class="card-header">
        <div class="card-title h6">
            <span class="timesince">
                {% blocktrans with created=message.created|timesince %}
                Sent {{ created }} ago by
                {% endblocktrans %}
                {% include "users/includes/chip.html" with profile=message.sender %}
                {% include "conversations/includes/parent.html" %}
            </span>
        </div>
    </div>
    <div class="card-body">
        {% include "conversations/includes/message.html" %}
    </div>
    <div class="card-footer">
        <div class="actions">
            <a href="{{ message.get_permalink }}">{% trans "Permalink" %}</a>
            {% if message.sender == request.user %}

            <a href="{% url 'conversations:message_update' message.id %}">{% trans "Edit" %}</a>

            <a href="{% url 'conversations:message_delete' message.id %}"
               data-controller="ajax confirm"
               data-action="confirm#check ajax#delete"
               data-ajax-redirect="{{ request.path }}"
               data-confirm-header="{% trans 'Delete' %}"
               data-confirm-body="{% trans 'Are you sure you want to delete this message?' %}"
               >{% trans "Delete" %}</a>

            {% elif not message.read %}
            <a href="{% url 'conversations:message_mark_read' message.id %}"
               data-controller="ajax"
               data-action="ajax#post"
               data-ajax-redirect="{{ request.path }}"
               >{% trans "Mark As Read" %}</a>
            {% endif %}
            {% include "conversations/includes/replies.html" %}
        </div>
    </div>
</div>
{% endfor %}
{% include "includes/pagination.html" %}
{% else %}
{% include "includes/empty.html" %}
{% endif %}
{% endblock %}
