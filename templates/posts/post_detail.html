{% extends "activities/base.html" %}

{% load i18n %}
{% load rules %}
{% load micawber_tags %}

{% block activities_content %}

{% has_perm "activities.like_post" user post as can_like_post %}
{% has_perm "activities.change_post" user post as can_change_post %}
{% has_perm "activities.delete_post" user post as can_delete_post %}
{% has_perm "activities.like_post" user post as can_like_post %}
{% has_perm "comments.create_comment" user post as can_create_comment %}

<div class="card content-card"
     >
     <div class="card-header">
       <div class="card-subtitle text-gray float-right">
         {% blocktrans with post.created|timesince as created %}{{ created }} ago{% endblocktrans %}
       </div>
  {% if post.title %}
  <div class="card-title h3">{{ post.title }}</div>
  <div class="card-subtitle h6"><a href="{{ post.owner.get_profile_url }}">{{ post.owner.username }}</a></div>
  {% else %}
  <div class="card-title h6"><a href="{{ post.owner.get_profile_url }}">{{ post.owner.username }}</a></div>
  {% endif %}
     </div>
     <div class="card-body">
       <div class="divider"></div>
       {% if post.description %}
       <div>
         {{ post.description.markdown }}
       </div>
       {% endif %}
       {% if post.url %}
       <div>
         {{ post.url|oembed }}
       </div>
       {% endif %}
     </div>
     <div class="card-footer">

       <div class="d-flex content-actions">

         {% if post.owner_id == user.id %}
         <div class="mr-2">{% trans "Likes" %} ({{ post.num_likes }})</div>
         {% elif can_like_post %}
         <div class="mr-2">
           <a href="#"
              data-controller="ajax"
              data-action="ajax#post"
              data-ajax-url=""
              data-ajax-replace="true"
              >{% trans "Like" %}</a>
         </div>
         {% endif %}

         <!--
           <div class="mr-2">
           <a href="">{% trans "Flag" %}</a>
           </div>
         -->

         {% if can_change_post %}
         <div class="mr-2">
           <a href="{% url 'posts:update' post.id %}"
              >{% trans "Update" %}</a>
         </div>
         {% endif %}

         {% if can_delete_post %}
         <div class="mr-2">
           {% url 'posts:delete' post.id as delete_url %}
           <a href="{{ delete_url }}"
              data-controller="ajax confirm"
              data-action="confirm#check ajax#delete"
              data-ajax-url="{{ delete_url }}"
              data-confirm-header="{% trans 'Delete Post' %}"
              data-confirm-body="{% trans 'Are you sure you want to delete this post?' %}"
              >{% trans "Delete" %}</a>
         </div>
         {% endif %}

         <div class="">
           <a href="{{ post.get_permalink }}">{% trans "Permalink" %}</a>
         </div>
       </div>
     </div>

</div>

<div class="divider"></div>

<div id="comments">
  {% if post.comments %}
  <h4>{% trans "Comments" %}</h4>
  {% endif %}
  {% for comment in post.comments %}
  <div class="mb-2">
    {% include "comments/includes/comment.html" %}
  </div>
  {% endfor %}
  {% if comment_form %}
  <div class="divider"></div>
  <h4>{% trans "Post a Comment" %}</h4>
  <form method="POST" action="" data-controller="form" data-action="form#submit">
    {% include "includes/forms/fields.html" with form=comment_form %}
    <button class="btn btn-primary" type="submit">{% trans "Submit" %}</button>
  </form>
  {% elif not user.is_authenticated %}
  <p class="bg-gray p-2 text-center">
    {% url 'account_login' as login_url %}
    {% blocktrans %}Please <a href="{{ login_url }}">sign in</a> to post comments.{% endblocktrans %}
  </p>
  {% else %}
  <p class="bg-gray p-2 text-center">
    {% trans "You do not have permission to post comments on this site." %}
  </p>

  {% endif %}
</div>
{% endblock activities_content %}
