{% extends "content/base.html" %}

{% load i18n %}
{% load rules %}
{% load micawber_tags %}
{% load likes_tags %}

{% block content_main_panel %}

{% has_perm "content.like_post" user post as can_like_post %}
{% has_perm "content.change_post" user post as can_change_post %}
{% has_perm "content.delete_post" user post as can_delete_post %}
{% has_perm "content.like_post" user post as can_like_post %}
{% has_perm "comments.create_comment" user post as can_create_comment %}

<div class="card content-card">
  <div class="card-header">
    <div class="card-subtitle text-gray float-right">
      {% blocktrans with post.created|timesince as created %}{{ created }} ago{% endblocktrans %}
    </div>
    {% if post.title %}
    <div class="card-title h3">{{ post.title }}</div>
    <div class="card-subtitle h6"><a href="{{ post.author.get_profile_url }}">{{ post.author.username }}</a></div>
    {% else %}
    <div class="card-title h6"><a href="{{ post.author.get_profile_url }}">{{ post.author.username }}</a></div>
    {% endif %}
  </div>
  <div class="card-body">
    <div class="divider"></div>
    {% if post.description %}
    <div>
      {{ post.markdown }}
    </div>
    {% endif %}
    {% if post.url %}
    <div>
      {{ post.url|oembed }}
    </div>
    {% endif %}
  </div>
  <div class="card-footer">

    <div class="d-flex content-actions">

      {% if post.author_id == user.id %}
      <div class="mr-2">{% trans "Likes" %} ({{ post.num_likes }})</div>
      {% elif can_like_post %}
      <div class="mr-2">
        {% has_liked post as has_liked_post %}
        <a href="#" data-like="{% url 'content:like' post.id %}">{% if has_liked_post %}{% trans "Unlike" %}{% else %}{% trans "Like" %}{% endif %}</a>
      </div>
      {% endif %}


      <div class="mr-2">
        <a href="">{% trans "Flag" %}</a>
      </div>

      {% if can_change_post %}
      <div class="mr-2">
        <a href="{% url 'content:update' post.id %}"
           >{% trans "Update" %}</a>
      </div>
      {% endif %}

      {% if can_delete_post %}
      {% url "content:delete" post.id as delete_url %}
      <div class="mr-2">
        <a href="{{ delete_url }}"
           data-delete-from="{{ delete_url }}"
           data-redirect-on-delete="{% url 'content:list' %}"
           data-confirm-dialog
           data-confirm-title="{% trans 'Delete Post' %}"
           data-confirm-content="{% trans 'Are you sure you want to delete this post?' %}"
           data-confirm-trigger="delete:confirm"
>{% trans "Delete" %}</a>
      </div>
      {% endif %}

      <div class="">
        <a href="{{ post.get_permalink }}">{% trans "Permalink" %}</a>
      </div>
    </div>
  </div>

</div>

<div class="divider"></div>

<div id="comments">
  {% if post.comments %}
  <h4>{% trans "Comments" %}</h4>
  {% endif %}
  {% for comment in post.comments %}
  <div class="mb-2">
    {% include "comments/includes/comment.html" %}
  </div>
  {% endfor %}
  {% if comment_form %}
  <div class="divider"></div>
  <h4>{% trans "Post a Comment" %}</h4>
  <form method="POST" action="{% url 'comments:create' post.id %}" data-turbolinks-submit>
    {% include "includes/forms/fields.html" with form=comment_form %}
    <button class="btn btn-primary" type="submit">{% trans "Submit" %}</button>
  </form>
  {% elif not user.is_authenticated %}
  <p class="bg-gray p-2 text-center">
    {% url 'account_login' as login_url %}
    {% blocktrans %}Please <a href="{{ login_url }}">sign in</a> to post comments.{% endblocktrans %}
  </p>
  {% else %}
  <p class="bg-gray p-2 text-center">
    {% trans "You do not have permission to post comments on this site." %}
  </p>

  {% endif %}
</div>
{% endblock content_main_panel %}
