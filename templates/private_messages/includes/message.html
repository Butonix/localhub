{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% load i18n %}

<div class="card mb-1{% if is_sender %} bg-gray{% endif %}">
  <div class="card-header">
    <div class="card-title h6">
      <div class="timesince">
        {% blocktrans with created=message.created|timesince %}
        Sent {{ created }} ago
        {% endblocktrans %}
        {% if show_sender_info %}
        {% trans "from" %}
        {% include "users/includes/chip.html" with profile=message.sender profile_url=sender_url %}
        {% endif %}
        {% if show_recipient_info %}
        {% trans "to" %}
        {% include "users/includes/chip.html" with profile=message.recipient profile_url=recipient_url %}
        {% endif %}
        {% if show_parent_info %}
        {% with parent=message.parent %}
        {% if parent %}
        {% blocktrans with parent_id=parent parent_url=parent.get_absolute_url parent_id=parent.id abbr=parent.get_abbreviation %}
        in reply to <a href="{{ parent_url }}">{{ abbr }}</a>
        {% endblocktrans %}
        {% endif %}
        {% endwith %}
        {% endif %}
      </div>
    </div>
  </div>
  <div class="card-body">
    {% if message.message|wordcount > 60 and not is_detail %}
    <div data-controller="toggle">
      <div class="markdown-content d-hide" data-target="toggle.togglable">
        {{ message.message.markdown }}
      </div>
      <div class="markdown-content" data-target="toggle.togglable">
        {{ message.message.markdown|truncatewords_html:60 }}
      </div>
      <a href="#" data-action="toggle#toggle" data-target="toggle.togglable">{% trans "Read more" %}</a>
    </div>
    {% else %}
    <div class="markdown-content">
      {{ message.message.markdown }}
    </div>
    {% endif %}
  </div>
  <div class="card-footer">
    <div class="actions">
      <a href="{{ message.get_permalink }}">{% trans "Permalink" %}</a>
      {% if not message.read and is_recipient %}
      <a href="{% url 'private_messages:message_mark_read' message.id %}"
         data-controller="ajax"
         data-action="ajax#post"
         data-ajax-redirect="{{ request.path }}"
         >{% trans "Mark As Read" %}</a>
      {% endif %}
      {% if is_sender %}
      <a href="{% url 'private_messages:message_update' message.id %}">{% trans "Edit" %}</a>
      <a href="{% url 'private_messages:message_delete' message.id %}"
         data-controller="ajax confirm"
         data-action="confirm#check ajax#post"
         data-ajax-redirect="{{ post_delete_redirect|default:request.path }}"
         data-confirm-header="{% trans 'Delete' %}"
         data-confirm-body="{% trans 'Are you sure you want to delete this message?' %}"
         >{% trans "Delete" %}</a>
      {% endif %}
      {% if can_reply %}
      <a href="{% url 'private_messages:message_reply' message.id %}">{% trans "Reply To Message" %}</a>
      {% elif reply and show_reply_info %}
      <a href="{{ reply.get_absolute_url }}">{% trans "View Reply" %}</a>
      {% endif %}
    </div>
  </div>
</div>

