{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% load i18n %}
{% load account %}

<div class="card mb-2{% if is_sender %} bg-gray{% endif %}"
     id="message-{{ message.id }}">
  <div class="card-header">
    <div class="card-title h6">
      {% include "users/includes/chip.html" with profile=message.sender profile_url=sender_url %}
      <span class="timesince">
        {% trans "to" %}
      </span>
      {% include "users/includes/chip.html" with profile=message.recipient profile_url=recipient_url %}
      <span class="timesince">
        {% blocktrans with created=message.created|timesince %}
        {{ created }} ago
        {% endblocktrans %}
        {% if parent %}
        {% if is_follow_up %}
        {% trans "in follow-up to" %}
        {% else %}
        {% trans "in reply to" %}
        {% endif %}
        <a {% if is_thread %}
           data-turbolinks="false"
           {% endif %}
           href="{{ parent_url }}">#{{ parent.id }}</a>
        {% endif %}
      </span>
      {% if is_recipient and not message.read %}
      <div class="chip bg-primary">{% trans "New" %}</div>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    {% collapsable is_detail %}
    <div class="markdown-content">
      {{ message.message.markdown }}
    </div>
    {% endcollapsable %}
  </div>
  <div class="card-footer">
    {% if not is_detail %}
    {% with num_replies=message.num_replies|default:0 %}
    {% if num_replies %}
    <div class="info">
      This message has <a href="{{ message_url }}">
        {% blocktrans count counter=num_replies %}
        one reply.
        {% plural %}
        {{ counter }} replies.
        {% endblocktrans %}
      </a>
    </div>
    {% endif %}
    {% endwith %}
    {% endif %}

    {% with num_follow_ups=message.num_follow_ups|default:0 %}
    {% if num_follow_ups %}
    <div class="info">
      This message has <a href="{{ message_url }}">
        {% blocktrans count counter=num_follow_ups %}
        one follow up.
        {% plural %}
        {{ counter }} follow up.
        {% endblocktrans %}
      </a>
    </div>
    {% endif %}
    {% endwith %}

    <div class="actions">
      {% if can_reply %}
      <a href="{% url 'private_messages:message_reply' message.id %}">
        {% trans "Reply" %}
      </a>
      {% elif can_follow_up %}
      <a href="{% url 'private_messages:message_follow_up' message.id %}">
        {% trans "Follow-Up" %}
      </a>
      {% endif %}
      {% if is_recipient and not message.read %}
      <a href="{% url 'private_messages:message_mark_read' message.id %}"
         class="d-hide"
         data-controller="js-toggle ajax"
         data-action="ajax#post"
         data-ajax-redirect="{{ request.path }}">{% trans "Mark As Read" %}</a>
      {% endif %}
      <a href="{% url 'private_messages:message_delete' message.id %}"
         data-controller="ajax confirm"
         data-action="confirm#check ajax#post"
         data-ajax-redirect="{{ post_delete_redirect|default:request.path }}"
         data-confirm-header="{% trans 'Delete Message' %}"
         data-confirm-body="{% trans "Are you sure you want to delete this message? Replies to this message will not be deleted. The message may still be available to the other person." %}">{% trans "Delete" %}</a>

      <a href="{{ message.get_permalink }}">{% trans "Permalink" %}</a>
    </div>
  </div>
</div>