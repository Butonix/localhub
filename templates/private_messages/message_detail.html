{% extends "private_messages/base.html" %}

{% load i18n %}
{% load account %}
{% load rules %}

{% block content %}

{% include "includes/breadcrumbs.html" %}

<h3>{% trans "Messages" %}</h3>

<div class="divider"></div>

<div class="card">
    <div class="card-header">
        <div class="card-title h6">
            <span class="timesince">
                {% blocktrans with created=message.created|timesince %}
                Sent {{ created }} ago from
                {% endblocktrans %}

                {% include "users/includes/chip.html" with profile=message.sender %}
                {% trans "to" %}
                {% include "users/includes/chip.html" with profile=message.recipient %}

                {% include "private_messages/includes/parent.html" %}
            </span>
        </div>
    </div>
    <div class="card-body">
        <div class="markdown-content">
            {{ message.message.markdown }}
        </div>
    </div>
    <div class="card-footer">
        <div class="actions">
            <a href="{{ message.get_permalink }}">{% trans "Permalink" %}</a>
            {% if message.sender == request.user %}

            <a href="{% url 'private_messages:message_update' message.id %}">{% trans "Edit" %}</a>

            <a href="{% url 'private_messages:message_delete' message.id %}"
               data-controller="ajax confirm"
               data-action="confirm#check ajax#delete"
               data-confirm-header="{% trans 'Delete' %}"
               data-confirm-body="{% trans 'Are you sure you want to delete this message?' %}"
               data-ajax-redirect="{{ sender_url }}"
               >{% trans "Delete" %}</a>

            {% elif not message.read %}
            <a href="{% url 'private_messages:message_mark_read' message.id %}"
               data-controller="ajax"
               data-action="ajax#post"
               data-ajax-redirect="{{ request.path }}"
               >{% trans "Mark As Read" %}</a>
            {% endif %}
            {% include "private_messages/includes/replies.html" %}
        </div>
    </div>
</div>

{% if replies %}
<div class="divider"></div>
<h4>{% trans "Replies" %}</h4>

{% for reply in replies %}
<div class="card mb-1">
    <div class="card-header">
        <div class="card-title h6">
            <span class="timesince">
                {% blocktrans with created=message.created|timesince %}
                Sent {{ created }} ago from
                {% endblocktrans %}
                {% include "users/includes/chip.html" with profile=reply.sender %}
                {% trans "to" %}
                {% include "users/includes/chip.html" with profile=reply.recipient %}
            </span>
        </div>
    </div>
    <div class="card-body">
        {% include "private_messages/includes/message.html" with message=reply %}
    </div>
    <div class="card-footer">
        <div class="actions">
            <a href="{{ reply.get_permalink }}">{% trans "Permalink" %}</a>
            {% if reply.sender == request.user %}
            <a href="{% url 'private_messages:message_update' message.id %}">{% trans "Edit" %}</a>
            <a href="{% url 'private_messages:message_delete' reply.id %}"
               data-controller="ajax confirm"
               data-action="confirm#check ajax#delete"
               data-confirm-header="{% trans 'Delete' %}"
               data-confirm-body="{% trans 'Are you sure you want to delete this message?' %}"
               data-ajax-redirect="{{ sender_url }}"
               >{% trans "Delete" %}</a>

            {% elif not reply.read %}
            <a href="{% url 'private_messages:message_mark_read' reply.id %}"
               data-controller="ajax"
               data-action="ajax#post"
               data-ajax-redirect="{{ request.path }}"
               >{% trans "Mark As Read" %}</a>
            {% endif %}
            {% include "private_messages/includes/replies.html" with message=reply %}
        </div>
    </div>
</div>

{% endfor %}
{% endif %}

{% endblock content %}

