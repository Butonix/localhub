{# Copyright (c) 2020 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}
{% spaceless %}

{% load static %}
{% load i18n %}
{% load rules %}
{% load thumbnail %}
{% load activities %}
{% load communities %}
{% load users %}

{% test_rule "communities.is_member" user community as is_member %}
{% has_perm "communities.view_community" user community as can_view_community %}

{% get_site_counters user community as site_counters %}
{% get_external_site_counters user community as external_site_counters %}

{% endspaceless %}

{% with site_counters_total=site_counters.total|add:external_site_counters.total %}

<!DOCTYPE html>
{% get_current_language as language_code %}
<html lang="{{ language_code }}">

<head>
  <title>
    {% spaceless %}{% block title %}{% if site_counters_total %}*{% endif %}{% if community %}{{ community.name }}{% endif %}{% block subtitle %}{% endblock %}{% endblock %}{% endspaceless %}
  </title>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="turbolinks-cache-control"
        content="no-cache">
  <meta name="copyright"
        content="Dan Jacob {% now "Y" %}">
  <meta name="description"
        content="Open source community web application">
  <meta name="keywords"
        content="open source,communities,private,local">
  <meta name="robots"
        content="index,follow">
  <link rel="icon"
        type="image/png"
        href="{% static 'favicon.png' %}">
  <link rel="apple-touch-icon image_src"
        href="{% static 'apple-touch-icon.png' %}">
  <script defer
          src="{% static 'dist/main.js' %}"></script>
</head>

<body class="h-screen container-lg mx-auto antialiased">

  {% block header %}
  <header class="flex items-center justify-between p-3 bg-gray-900 text-gray-100 px-5">
    {% if community %}
    <div class="flex items-center flex-shrink-0 mr-6">
      <a href="{{ home_page_url }}"
         class="text-xl tracking-tight text-white hover:text-gray-100">{{ community.name }}</a>
    </div>
    {% endif %}
    <div class="hidden lg:block">
      <form method="GET"
            action="{% url 'activities:search' %}"
            data-controller="form"
            data-action="form#submit">
        <input type="search"
               placeholder="{% trans "Search..." %}"
               name="q"
               class="appearance-none border border-gray-500 w-full p-1 text-gray-900">
      </form>
    </div>
    {% if user.is_authenticated %}
    <div>
      {% thumbnail user.avatar "20" as avatar %}
      <img src="{{ avatar.url }}"
           class="inline-block mr-1 full-rounded"
           height="20"
           width="20">
      {% endthumbnail %}
      <a href="{{ user.get_absolute_url }}"
         class="inline-block text-white hover:text-gray-100 mr-4">
        {{ user.username }}
      </a>
      <a href="{% url 'account_logout' %}"
         class="inline-block text-white hover:text-gray-100"
         data-turbolinks="false"
         data-controller="ajax"
         data-action="ajax#post"
         data-ajax-redirect="{{ home_page_url }}">{% trans "Logout" %}</a>
    </div>
    {% else %}
    <div>
      <a href="{% url 'account_login' %}"
         class="inline-block text-white hover:text-gray-100 mr-4">{% trans "Login" %}</a>
      <a href="{% url 'account_signup' %}"
         class="inline-block text-white hover:text-gray-100">{% trans "Signup" %}</a>
    </div>
    {% endif %}
  </header>
  {% endblock header %}

  {% block mobile_search %}
  <div class="bg-gray-900 px-5 py-3 lg:hidden">
    <form method="GET"
          action="{% url 'activities:search' %}"
          data-controller="form"
          data-action="form#submit">
      <input type="search"
             placeholder="{% trans "Search..." %}"
             name="q"
             class="appearance-none border border-gray-500 w-full p-1 text-gray-900">
    </form>
  </div>
  {% endblock mobile_search %}

  {% block layout %}

  {% if messages %}
  <div class="flex justify-center">
    {% for message in messages %}
    <div class="absolute z-50 w-4/5 lg:w-1/3 flex items-center text-center p-3 mb-2 text-white {{ message.tags }}"
         data-controller="alert">
      <div class="mx-auto text-center">
        {{ message }}
      </div>
      <button data-action="alert#dismiss"
              class="">
        <svg class="fill-current text-white"
             xmlns="http://www.w3.org/2000/svg"
             width="18"
             height="18"
             viewBox="0 0 18 18">
          <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
        </svg>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}


  <div class="flex justify-center hidden"
       data-controller="toast">
    <div data-target="toast.container"
         class="fixed z-50 w-4/5 lg:w-1/3 flex items-center text-center p-3 text-white">
      <div class="mx-auto text-center"
           data-target="toast.message">
      </div>
      <button data-action="toast#dismiss"
              class="">
        <svg class="fill-current text-white"
             xmlns="http://www.w3.org/2000/svg"
             width="18"
             height="18"
             viewBox="0 0 18 18">
          <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
        </svg>
      </button>
    </div>
  </div>

  <div class="mt-5 px-5 flex min-h-full"
       data-controller="sidebar"
       data-sidebar-toggle-class="hidden">

    {% block sidebar %}
    {% include "includes/sidebar.html" %}
    {% endblock sidebar %}

    {% block main_section %}
    <main class="lg:ml-5 w-full lg:w-5/6"
          data-target="sidebar.main">
      <!-- mobile "menu" button -->
      <button class="btn btn-block lg:hidden mb-4"
              data-action="sidebar#toggle">
        {% trans "Menu" %}
        {% if site_counters_total %}
        <span class="inline-flex items-center bg-blue-600 rounded text-white font-bold p-1 px-2 ml-2 justify-center text-xs">{% trans "New" %}</span>
        {% endif %}

      </button>

      {% block content %}{% endblock %}
    </main>
    {% endblock main_section %}

  </div>
  {% endblock layout %}

  {% include "includes/footer.html" %}
  {% include "includes/confirm_dialog.html" %}

</body>

</html>
{% endwith %}
